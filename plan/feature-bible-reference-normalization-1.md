---
goal: Normalize Bible References in Transcript Text via AST Pipeline
version: 1.0
date_created: 2026-02-16
last_updated: 2026-02-16
owner: WhisperSermons Development
status: 'Planned'
tags: [feature, bible-references, normalization, pipeline, ast, text-processing]
---

# Introduction

![Status: Planned](https://img.shields.io/badge/status-Planned-blue)

Implement Bible reference normalization in the transcript text so that malformed, run-together, or speech-transcribed references are replaced with properly formatted `Book Chapter:Verse` notation in the final output. Whisper (and other ASR engines) commonly produce references like `"Romans 829"` (should be `"Romans 8:29"`), `"Galatians 1-6"` (should be `"Galatians 1:6"`), and `"Romans 1, 21 and 22"` (should be `"Romans 1:21-22"`). The normalization should only activate when the malformed form is clearly a transcription artifact — never when the original form is intentionally verbose speech (e.g., `"Matthew chapter 2 verses 1 through 12"` is preserved as-is).

This was previously attempted but abandoned because normalizing the raw text before passage detection caused coordinate-space mismatches in `QuoteBoundary.start_pos/end_pos`. Now that the AST-first pipeline is in place, normalization can be performed **after** passage boundaries are applied to the AST, operating on `TextNode.content` values rather than the immutable `raw_text`. This eliminates the class of bugs that previously made normalization impractical.

**Strategy**: Normalize reference text inside `TextNode` content strings at a new AST-stage (Phase 1b) that runs after `apply_passages_to_ast()` but before `segment_ast_paragraphs()`. The original text remains untouched in `raw_text`; only the AST `TextNode.content` values are modified. `PassageNode` content is never touched (it contains the actual quoted Bible verse text, not the spoken reference).

## 1. Requirements & Constraints

### Requirements

- **REQ-001**: Normalize malformed Bible references in `TextNode.content` strings to standard `Book Chapter:Verse` format
- **REQ-002**: Only normalize when the reference is clearly a transcription artifact — speech patterns using words like "chapter", "verses", "through" must be preserved verbatim
- **REQ-003**: Normalization must handle the following transcription patterns:
  - Run-together numbers: `"Romans 829"` → `"Romans 8:29"`, `"Hebrews 725"` → `"Hebrews 7:25"`
  - Hyphen as separator: `"Galatians 1-6"` → `"Galatians 1:6"` (single verse, not a chapter range)
  - Comma-separated: `"Revelation 19, 16"` → `"Revelation 19:16"`
  - Enumeration with "and": `"Romans 1, 21 and 22"` → `"Romans 1:21-22"`
  - Period separator: `"Romans 12.1"` → `"Romans 12:1"`
- **REQ-004**: Normalization must NOT alter:
  - Verbose speech patterns: `"Matthew chapter 2 verses 1 through 12"` (preserved as-is)
  - Already-correct references: `"John 3:16"` (no change)
  - `PassageNode` content (quoted Bible verse text)
  - `raw_text` (the immutable original transcript)
- **REQ-005**: Each normalization must be validated against the Bible API (or local chapter-count data) before applying — never produce an invalid reference
- **REQ-006**: Normalization metadata must be recorded so original text can be recovered (store `original_text` alongside `normalized_text` on each normalization event)
- **REQ-007**: A local `BOOK_CHAPTER_COUNTS` lookup table must be added to enable offline validation of chapter numbers without an API call, reducing false positives (e.g., rejecting `"Matthew 63:3"` without needing to call the API)
- **REQ-008**: The coordinate-space contract must remain unbroken — `QuoteBoundary.start_pos/end_pos` values reference the unmodified `raw_text`, and `process_text()` continues to return the original text unmodified

### Security & Data Integrity

- **SEC-001**: Normalization must be idempotent — applying it twice produces the same result
- **SEC-002**: No text outside of a recognized Bible reference pattern may be altered

### Constraints

- **CON-001**: `process_text()` in `bible_quote_processor.py` must continue to return unmodified text — no coordinate-space mutation during boundary detection
- **CON-002**: `PassageNode` content is never modified by normalization (it contains the actual verse text, not the spoken reference)
- **CON-003**: The `DocumentState` output schema (`document_model.py` / `documentModel.ts`) must not change
- **CON-004**: Normalization must not affect passage detection accuracy — it runs **after** boundaries are applied to the AST
- **CON-005**: The existing `normalize_references_in_text()` function in `bible_quote_processor.py` is a separate utility and must not be called by the AST pipeline — a new AST-aware function is needed
- **CON-006**: No changes to `src/preload/index.ts`, IPC contracts, or renderer code
- **CON-007**: Run-together number splitting must reuse the existing `split_runtogether_number()` logic, not duplicate it

### Guidelines

- **GUD-001**: Operate on `TextNode.content` strings — these are display text, not coordinate-space anchors
- **GUD-002**: Process normalization per-paragraph to avoid cross-paragraph side effects
- **GUD-003**: Use debug logging consistent with existing `_debug_log()` pattern
- **GUD-004**: Normalization rules must be ordered longest-match-first to prevent shorter patterns from consuming parts of longer patterns
- **GUD-005**: All new functions must have clear docstrings documenting inputs, outputs, edge cases, and invariants
- **PAT-001**: Follow the existing feature-module pattern — normalization logic lives in `bible_quote_processor.py` as pure functions, AST integration lives in `ast_builder.py`

## 2. Implementation Steps

### Phase 1: Add Local Chapter-Count Validation Data

- GOAL-001: Add a `BOOK_CHAPTER_COUNTS` dictionary mapping each Bible book to its number of chapters, enabling offline validation of chapter numbers without an API call. This is essential for preventing false positives in normalization (e.g., not normalizing `"Matthew 63"` as `"Matthew 6:3"` if the intent was actually chapter 63 — which doesn't exist, so it's clearly a run-together number, but for single-chapter books like Jude or Obadiah, we must know the chapter count to avoid misinterpreting `"Jude 12"` as chapter 1 verse 2 when it's actually verse 12 of the sole chapter).

| Task     | Description                                                                                                                                                                                                                                                                                                                                                             | Completed | Date |
| -------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------- | ---- |
| TASK-001 | Add `BOOK_CHAPTER_COUNTS` dictionary to `bible_quote_processor.py` after `BOOK_ID_MAP` (around line 70). Maps canonical book name (`str`) → max chapter count (`int`). Example: `{'Genesis': 50, 'Exodus': 40, ..., 'Revelation': 22}`. All 66 Protestant canon books must be included. Single-chapter books (Obadiah, Philemon, 2 John, 3 John, Jude) must map to `1`. |           |      |
| TASK-002 | Add a `SINGLE_CHAPTER_BOOKS` frozen set derived from `BOOK_CHAPTER_COUNTS` containing all book names where chapter count is 1: `{'Obadiah', 'Philemon', '2 John', '3 John', 'Jude'}`. This set is used to short-circuit normalization logic for single-chapter books where `"Jude 12"` means verse 12, not chapter 12.                                                  |           |      |
| TASK-003 | Add helper function `is_valid_chapter(book: str, chapter: int) -> bool` that checks whether a chapter number is within the valid range for a book using `BOOK_CHAPTER_COUNTS`. Returns `False` for chapters ≤ 0 or exceeding the max. Returns `True` if the book is not in the lookup (fallback to permissive).                                                         |           |      |
| TASK-004 | Add unit tests for `BOOK_CHAPTER_COUNTS` completeness (all 66 books present), `SINGLE_CHAPTER_BOOKS` correctness, and `is_valid_chapter()` edge cases (valid chapter, invalid chapter, unknown book fallback). File: `src/python/test_reference_normalization.py`.                                                                                                      |           |      |

### Phase 2: Implement Core Normalization Functions

- GOAL-002: Create the pure normalization functions that transform a text string by replacing malformed Bible references with properly formatted versions. These are pure functions (text in → text out) with no AST awareness, operating on individual text segments.

| Task     | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | Completed | Date |
| -------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------- | ---- |
| TASK-005 | Create `normalize_reference_in_text_segment()` function in `bible_quote_processor.py`. Takes a text segment (string) and returns `(normalized_text, list_of_normalizations)` where each normalization is a `ReferenceNormalization` dataclass recording `original_text`, `normalized_text`, `position`, `book`, `chapter`, `verse_start`, `verse_end`, and `rule_applied` (which pattern triggered it).                                                                                                                                                                                                                                                                                                                                                                 |           |      |
| TASK-006 | Define `ReferenceNormalization` dataclass in `bible_quote_processor.py` with fields: `original_text: str`, `normalized_text: str`, `position: int`, `book: str`, `chapter: int`, `verse_start: Optional[int]`, `verse_end: Optional[int]`, `rule_applied: str` (pattern name for debugging).                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |           |      |
| TASK-007 | Implement normalization rule: **Run-together numbers**. Pattern: `Book + space + digits (3+ chars, no separator)`. Example: `"Romans 829"` → `"Romans 8:29"`. Use `split_runtogether_number()` for splitting logic. Validate with `is_valid_chapter()`. Only apply when the split produces a valid reference. Skip if the number is ≤ 2 digits (likely a chapter-only reference). For single-chapter books, `"Jude 12"` stays as `"Jude 12"` (it's verse 12) — do NOT add a colon since the existing detection already handles this as `Jude 1:12` internally via the chapter-less reference pattern.                                                                                                                                                                   |           |      |
| TASK-008 | Implement normalization rule: **Hyphen as chapter:verse separator**. Pattern: `Book + space + digit(s) + hyphen + digit(s)`. Example: `"Galatians 1-6"` → `"Galatians 1:6"`. Must validate that the chapter exists in `BOOK_CHAPTER_COUNTS` and that the verse is a plausible verse number (≤ 200). Must NOT match actual chapter ranges like `"Genesis 1-3"` (chapters 1 through 3). Heuristic: if both numbers are valid chapters and the second number is > the first, it's likely a chapter range → do NOT normalize. If the first number is a valid chapter and the second number is plausible as a verse (especially if it's a high number like 6, suggesting it's unlikely to be only chapter 6), verify via `api_client.verify_reference()` before normalizing. |           |      |
| TASK-009 | Implement normalization rule: **Comma as chapter:verse separator**. Pattern: `Book + space + digit(s) + comma + space? + digit(s)`. Example: `"Revelation 19, 16"` → `"Revelation 19:16"`. This pattern already exists in `detect_bible_references()` (the `book6` pattern), so this normalization mirrors its detection logic. Only apply when not followed by another comma+digit (which would indicate enumeration like `"Romans 12, 1, 2"`).                                                                                                                                                                                                                                                                                                                        |           |      |
| TASK-010 | Implement normalization rule: **Enumeration with "and"**. Pattern: `Book + space + digit(s) + comma + space? + digit(s) + (comma? + space? + "and" + space + digit(s))`. Example: `"Romans 1, 21 and 22"` → `"Romans 1:21-22"`. Validate that the chapter exists and both verses are plausible. If the two verse numbers are consecutive, produce a range (`21-22`). If they are non-consecutive, produce comma-separated verses (`21, 23` → `"Romans 1:21, 23"` — though this is rare and may be left as-is).                                                                                                                                                                                                                                                          |           |      |
| TASK-011 | Implement normalization rule: **Period as separator**. Pattern: `Book + space + digit(s) + period + digit(s)`. Example: `"Romans 12.1"` → `"Romans 12:1"`. Must NOT match when followed by more digits that indicate a decimal or sentence-ending period (e.g., end of sentence `"... in Romans 12."` should not grab the next sentence's starting number).                                                                                                                                                                                                                                                                                                                                                                                                             |           |      |
| TASK-012 | Implement normalization rule: **Spoken verse numbers**. Pattern: `Book + space + digit(s) + space + word-number`. Example: `"Romans 12 one"` → `"Romans 12:1"`. Uses existing `WORD_TO_NUMBER` mapping. Only apply when the word matches a known number word and is followed by a word boundary. Note: this normalization replaces the word with a digit (`one` → `1`) which changes text length — this is safe because we operate on `TextNode.content`, not `raw_text`.                                                                                                                                                                                                                                                                                               |           |      |
| TASK-013 | Add a master dispatching function `normalize_bible_references_in_segment(text: str, api_client: Optional[BibleAPIClient] = None) -> Tuple[str, List[ReferenceNormalization]]` that applies all normalization rules in priority order (longest-match-first). Rules are applied left-to-right through the text, and each rule match consumes the matched span to prevent double-normalization. Takes an optional `api_client` for online validation of ambiguous cases; if `None`, uses only local `BOOK_CHAPTER_COUNTS` for validation.                                                                                                                                                                                                                                  |           |      |

### Phase 3: Integrate Normalization into AST Pipeline

- GOAL-003: Add a new AST processing stage (`normalize_ast_references`) that runs after `apply_passages_to_ast()` and before `segment_ast_paragraphs()` in the `ASTBuilder.build()` method. This stage walks all `TextNode` children and normalizes Bible references in their `content` strings.

| Task     | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | Completed | Date |
| -------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------- | ---- |
| TASK-014 | Create `normalize_ast_references()` function in `ast_builder.py`. Signature: `normalize_ast_references(root: DocumentRootNode, api_client: Optional[BibleAPIClient] = None, debug: bool = False) -> Tuple[DocumentRootNode, List[ReferenceNormalization]]`. Walks `root.children`, finds `ParagraphNode` children that are `TextNode` (not `PassageNode`), and applies `normalize_bible_references_in_segment()` to each `TextNode.content`. Updates `TextNode.content` in-place with the normalized text. Returns the modified root and a flat list of all normalizations applied. |           |      |
| TASK-015 | Integrate `normalize_ast_references()` into `ASTBuilder.build()` as Stage 2b (between Stage 2 `apply_passages` and Stage 3 `segment_paragraphs`). Add timing via `_start_stage('normalize_references')` / `_end_stage('normalize_references')`. Add debug logging showing the number of normalizations applied. Pass the `BibleAPIClient` from `process_text()` through to the builder (add optional `api_client` parameter to `build_ast()` and `ASTBuilder.build()`).                                                                                                             |           |      |
| TASK-016 | Add `normalization_count: int` field to `ProcessingMetadata` in `document_model.py` (default `0`). Update `ASTBuilder.build()` to set `self.processing_metadata.normalization_count = len(normalizations)`. Update `ProcessingMetadata.to_dict()` to include `'normalizationCount'`.                                                                                                                                                                                                                                                                                                |           |      |
| TASK-017 | Update `process_text_to_ast()` in `bible_quote_processor.py` to pass the `BibleAPIClient` instance to `build_ast()` so that online verification is available during normalization. The `api_client` is already constructed inside `process_text()` — it needs to be returned or passed through. Add an internal parameter or modify `process_text()` to return it as part of a richer result tuple (or create it fresh in `process_text_to_ast()`).                                                                                                                                 |           |      |
| TASK-018 | Update the convenience function `build_ast()` in `ast_builder.py` to accept and forward the `api_client` parameter.                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |           |      |

### Phase 4: Handle Edge Cases and Ambiguity

- GOAL-004: Implement disambiguation logic for ambiguous patterns where normalization could produce incorrect results, ensuring high precision over high recall.

| Task     | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | Completed | Date |
| -------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------- | ---- |
| TASK-019 | Implement chapter-range vs. chapter:verse disambiguation for hyphen patterns. When encountering `"Genesis 1-3"`, determine whether this is chapters 1 through 3 or chapter 1 verse 3. Heuristic: if the second number is ≤ the book's max chapter count AND the second number ≥ the first number AND the difference is small (≤ 5), it is likely a chapter range → do NOT normalize. If the first number is a valid chapter and the second number exceeds the book's max chapter count, it is definitely a chapter:verse reference → normalize. For truly ambiguous cases, prefer NOT normalizing (conservative approach). |           |      |
| TASK-020 | Implement single-chapter book handling. For books with only 1 chapter (Obadiah, Philemon, 2 John, 3 John, Jude), references like `"Jude 12"` are always verse 12 of chapter 1. The existing `detect_bible_references()` already handles this. The normalization should NOT add a colon (i.e., NOT produce `"Jude 1:12"` from `"Jude 12"`) because the display convention for single-chapter books uses just the verse number. Skip normalization entirely for single-chapter books unless the pattern is clearly malformed (e.g., `"Jude 1-12"` → `"Jude 1:12"` only if the hyphen is unambiguously a verse separator).    |           |      |
| TASK-021 | Handle negative lookbehind for numbered book prefixes. Patterns must not match `"and 2 Peter"` or `"and 1 John"` as `"[book] 2"` + `"Peter"`. Use the same negative lookahead patterns from the existing `detect_bible_references()` function to exclude these false positives.                                                                                                                                                                                                                                                                                                                                            |           |      |
| TASK-022 | Handle the case where a number after a book name is just a chapter reference with no verse. Example: `"Romans 8"` is chapter 8, not a malformed reference — do NOT normalize. The rule is: only normalize run-together numbers of 3+ digits, or when an explicit separator (hyphen, comma, period) is present between chapter and verse.                                                                                                                                                                                                                                                                                   |           |      |
| TASK-023 | Prevent normalization of references that are inside `PassageNode` content. A `PassageNode` contains actual Bible verse text and may contain embedded reference numbers (e.g., verse markers). The `normalize_ast_references()` function must skip `PassageNode` children entirely (already handled by TASK-014 which only processes `TextNode` children). Verify this with a dedicated test.                                                                                                                                                                                                                               |           |      |

### Phase 5: Comprehensive Testing

- GOAL-005: Build a comprehensive test suite covering all normalization patterns, edge cases, ambiguities, and pipeline integration. Tests should be deterministic (no API calls in unit tests).

| Task     | Description                                                                                                                                                                                                                                                                                                                                                                                           | Completed | Date |
| -------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------- | ---- |
| TASK-024 | Create test file `src/python/test_reference_normalization.py` with mock `BibleAPIClient` fixture that returns pre-configured verification results without making real HTTP requests. The mock should support `verify_reference()` and `get_verse()` with configurable return values.                                                                                                                  |           |      |
| TASK-025 | Test: **Run-together normalization** — `"Romans 829"` → `"Romans 8:29"`, `"Hebrews 725"` → `"Hebrews 7:25"`, `"Matthew 633"` → `"Matthew 6:33"`. Also test that valid chapter-only `"Romans 8"` is NOT normalized, and invalid splits are NOT applied.                                                                                                                                                |           |      |
| TASK-026 | Test: **Hyphen normalization** — `"Galatians 1-6"` → `"Galatians 1:6"`, `"Micah 5-2"` → `"Micah 5:2"`. Also test that actual chapter ranges `"Genesis 1-3"` are NOT normalized.                                                                                                                                                                                                                       |           |      |
| TASK-027 | Test: **Comma normalization** — `"Revelation 19, 16"` → `"Revelation 19:16"`. Also test that enumeration patterns like `"Romans 12, 1, 2"` are handled correctly (should become `"Romans 12:1-2"` or similar, not just `"Romans 12:1"`).                                                                                                                                                              |           |      |
| TASK-028 | Test: **Enumeration with "and"** — `"Romans 1, 21 and 22"` → `"Romans 1:21-22"`, `"Matthew 5, 44 and 45"` → `"Matthew 5:44-45"`. Also test non-consecutive verses and edge cases with numbered book names.                                                                                                                                                                                            |           |      |
| TASK-029 | Test: **Period normalization** — `"Romans 12.1"` → `"Romans 12:1"`. Also test sentence-ending periods are NOT consumed.                                                                                                                                                                                                                                                                               |           |      |
| TASK-030 | Test: **Spoken number normalization** — `"Romans 12 one"` → `"Romans 12:1"`. Test the full range of `WORD_TO_NUMBER` values.                                                                                                                                                                                                                                                                          |           |      |
| TASK-031 | Test: **Verbose speech preservation** — `"Matthew chapter 2 verses 1 through 12"` remains unchanged. `"Isaiah chapter 9"` remains unchanged. These use the word "chapter" and must NOT be normalized.                                                                                                                                                                                                 |           |      |
| TASK-032 | Test: **Already-correct references** — `"John 3:16"`, `"Romans 8:28-29"` remain unchanged.                                                                                                                                                                                                                                                                                                            |           |      |
| TASK-033 | Test: **Single-chapter book handling** — `"Jude 12"` remains unchanged (verse 12 of sole chapter). `"Obadiah 4"` remains unchanged. `"Philemon 15"` remains unchanged.                                                                                                                                                                                                                                |           |      |
| TASK-034 | Test: **Idempotency** (`SEC-001`) — normalizing already-normalized text produces no further changes. Apply normalization twice and assert identical output.                                                                                                                                                                                                                                           |           |      |
| TASK-035 | Test: **AST integration** — create a flat AST with TextNodes containing malformed references, run `normalize_ast_references()`, verify TextNode content is normalized and PassageNode content is untouched.                                                                                                                                                                                           |           |      |
| TASK-036 | Test: **Full pipeline integration** — use `process_text_to_ast()` with the test transcript (`test_mode_transcript.txt`), verify that references in TextNode content are normalized while passage boundaries remain correct. Specifically verify: `"Job thirty three four"` (spoken format with word numbers) and `"Galatians four"` (chapter-only, no normalization needed) remain correctly handled. |           |      |
| TASK-037 | Test: **Coordinate-space immutability** — assert that `process_text()` still returns the original text unmodified. Assert that `QuoteBoundary.start_pos/end_pos` values are valid indices into the original text. This is a regression test for the coordinate contract (`REQ-008`).                                                                                                                  |           |      |
| TASK-038 | Test: **Multiple references in one text segment** — `"He read Romans 829 and then Galatians 1-6"` should normalize both independently.                                                                                                                                                                                                                                                                |           |      |
| TASK-039 | Test: **Reference at text boundaries** — reference at start of text, at end of text, and as the entire text content.                                                                                                                                                                                                                                                                                  |           |      |

### Phase 6: Documentation and Cleanup

- GOAL-006: Document the normalization feature, update inline documentation, and ensure consistency across the codebase.

| Task     | Description                                                                                                                                                                                                                                            | Completed | Date |
| -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | --------- | ---- |
| TASK-040 | Add module-level docstring to the normalization section of `bible_quote_processor.py` explaining the normalization rules, when/why normalization is applied, and the coordinate-space contract.                                                        |           |      |
| TASK-041 | Update `process_text()` docstring and Phase 2 comment block to reference the new AST-level normalization (Phase 2 in `process_text()` is currently `SKIPPED` — add a note pointing to `normalize_ast_references()` as the new normalization location). |           |      |
| TASK-042 | Update the `ASTBuilder` class docstring to include Stage 2b (normalize references) in the pipeline description.                                                                                                                                        |           |      |

## 3. Alternatives

- **ALT-001**: **Normalize during `process_text()` before boundary detection** — This was the original approach and was abandoned because it introduced coordinate-space mismatches. All `QuoteBoundary` positions reference the unmodified text, so normalizing the text before boundary detection would shift all character offsets. Rejected because it caused more bugs than it solved.

- **ALT-002**: **Normalize only at the renderer level (TypeScript)** — Display the `normalizedReference` metadata from `BibleReferenceMetadata` instead of the original text. This works for passage attribution labels but does NOT normalize the spoken references in paragraph text (e.g., when a pastor says "Romans 829" in running text, the viewer still sees "Romans 829"). Rejected because it only solves half the problem.

- **ALT-003**: **Use a post-processing text mutation on the final output string** — Apply `normalize_references_in_text()` to the final text after all processing. Rejected because it would mutate text that the AST nodes reference, creating inconsistency between `TextNode.content` and the displayed text.

- **ALT-004**: **Normalize in the preload/IPC layer** — Apply normalization when the document is sent from main process to renderer. Rejected because it would add processing latency to IPC and violate the principle that the Python pipeline produces the final document.

## 4. Dependencies

- **DEP-001**: `bible_quote_processor.py` — existing `split_runtogether_number()`, `normalize_book_name()`, `BIBLE_BOOKS`, `WORD_TO_NUMBER`, `BibleAPIClient.verify_reference()` functions are consumed (not modified)
- **DEP-002**: `ast_builder.py` — existing `ASTBuilder.build()` pipeline, `apply_passages_to_ast()`, `_debug_log()`, `_build_passage_node()` functions are extended
- **DEP-003**: `document_model.py` — `ProcessingMetadata` class is extended with `normalization_count` field
- **DEP-004**: Bible API (bolls.life) — optional for online verification during normalization (graceful degradation if unavailable, using local `BOOK_CHAPTER_COUNTS` only)

## 5. Files

- **FILE-001**: `src/python/bible_quote_processor.py` — Add `BOOK_CHAPTER_COUNTS` dict, `SINGLE_CHAPTER_BOOKS` set, `is_valid_chapter()`, `ReferenceNormalization` dataclass, `normalize_reference_in_text_segment()`, `normalize_bible_references_in_segment()`. Update `process_text_to_ast()` to pass API client.
- **FILE-002**: `src/python/ast_builder.py` — Add `normalize_ast_references()` function, integrate into `ASTBuilder.build()` as Stage 2b, update `build_ast()` convenience function. Import `normalize_bible_references_in_segment` and `ReferenceNormalization` from `bible_quote_processor`.
- **FILE-003**: `src/python/document_model.py` — Add `normalization_count: int = 0` field to `ProcessingMetadata`, update `to_dict()`.
- **FILE-004**: `src/python/test_reference_normalization.py` — New test file with comprehensive test suite (TASK-024 through TASK-039).

## 6. Testing

- **TEST-001**: Unit tests for `BOOK_CHAPTER_COUNTS` completeness and `is_valid_chapter()` (TASK-004)
- **TEST-002**: Unit tests for each normalization rule in isolation — run-together, hyphen, comma, enumeration, period, spoken numbers (TASK-025 through TASK-030)
- **TEST-003**: Unit tests for preservation rules — verbose speech, already-correct, single-chapter books (TASK-031 through TASK-033)
- **TEST-004**: Idempotency test (TASK-034)
- **TEST-005**: AST integration test — TextNode normalization with PassageNode preservation (TASK-035)
- **TEST-006**: Full pipeline integration test using `test_mode_transcript.txt` (TASK-036)
- **TEST-007**: Coordinate-space regression test (TASK-037)
- **TEST-008**: Multi-reference and boundary tests (TASK-038, TASK-039)

## 7. Risks & Assumptions

- **RISK-001**: **False positive normalization** — a legitimate chapter range `"Genesis 1-3"` could be misinterpreted as `"Genesis 1:3"`. Mitigated by the disambiguation heuristic in TASK-019 (conservative: prefer NOT normalizing when ambiguous) and `BOOK_CHAPTER_COUNTS` validation.
- **RISK-002**: **The hyphen pattern is inherently ambiguous** — `"Romans 8-28"` could be chapters 8–28 or chapter 8 verse 28. The heuristic (if second number ≤ book's max chapter AND ≥ first, it's a chapter range) will correctly identify most cases. For the few truly ambiguous cases, the conservative approach (don't normalize) is safest.
- **RISK-003**: **Run-together splitting depends on API availability** — `split_runtogether_number()` calls the Bible API to verify splits. If the API is down, normalization for run-together numbers will be skipped (graceful degradation). Mitigation: the local `BOOK_CHAPTER_COUNTS` table can eliminate invalid chapters without an API call.
- **RISK-004**: **Text length changes from normalization may affect downstream processing** — `segment_ast_paragraphs()` uses sentence tokenization on `TextNode.content`. Since normalization runs before segmentation (Stage 2b), the segmentation will operate on the normalized text. This is actually desirable (cleaner text for embedding computation). Risk is minimal.
- **RISK-005**: **Single-chapter book ambiguity** — `"3 John 14"` could be verse 14, but 3 John only has 14 verses. This is handled correctly by not normalizing single-chapter books (TASK-020).
- **ASSUMPTION-001**: The existing `detect_bible_references()` function correctly identifies all Bible references in the text and its book/chapter/verse parsing is accurate. Normalization reuses these results rather than re-detecting.
- **ASSUMPTION-002**: The AST-first pipeline (`apply_passages_to_ast()`) has already been implemented and is stable. Normalization is a new stage inserted into this existing pipeline.
- **ASSUMPTION-003**: Normalization of reference text in `TextNode.content` does not need to be reflected back into `raw_text` or `QuoteBoundary` positions — these remain as the original transcript coordinates.

## 8. Related Specifications / Further Reading

- [feature-rewrite-pipeline.md](feature-rewrite-pipeline.md) — AST-first pipeline refactor plan (provides the pipeline architecture this feature integrates into)
- [Analysis: AST-First Pipeline Refactor.md](Analysis%3A%20AST-First%20Pipeline%20Refactor.md) — Analysis of the coordinate-space mismatch bugs that motivated the AST-first approach
- [fix-ast-bible-passage-boundary-alignment.md](fix-ast-bible-passage-boundary-alignment.md) — Related boundary alignment fixes
- [.github/document-model-instructions.md](../.github/document-model-instructions.md) — Document model architecture documentation
- Existing `normalize_references_in_text()` in `bible_quote_processor.py` (line 1165) — Previous non-AST normalization utility (not called by pipeline, available for reference)
